import streamlit as st
import pandas as pd
import numpy as np

# ==========================================
# 1. ãƒ‡ãƒ¼ã‚¿å®šç¾©
# ==========================================

# ğŸ™ï¸ å¯©æŸ»å“¡ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
JUDGES_MASTER = {
    "æ¾æœ¬äººå¿—": {"avg": 91.5, "std": 3.0, "desc": "ã‚«ãƒªã‚¹ãƒãƒ»ãƒãƒ©ãƒ³ã‚¹å‹", "icon": "ğŸ‘‘"},
    "ä¸Šæ²¼æµç¾å­": {"avg": 94.5, "std": 6.5, "desc": "æƒ…ç†±ãƒ»ç›´æ„Ÿé‡è¦–å‹", "icon": "ğŸ’ƒ"},
    "åšå¤šå¤§å‰": {"avg": 90.5, "std": 1.8, "desc": "è«–ç†ãƒ»æŠ€è¡“è©•ä¾¡å‹", "icon": "ğŸ‘¨â€ğŸ«"},
    "å¯Œæ¾¤ãŸã‘ã—": {"avg": 92.5, "std": 2.2, "desc": "æ§‹æˆãƒ»è·äººè©•ä¾¡å‹", "icon": "ğŸ¥ª"},
    "å±±ç”°é‚¦å­": {"avg": 93.0, "std": 7.0, "desc": "äºˆæ¸¬ä¸èƒ½ãƒ»çˆ†ç™ºå‹", "icon": "ğŸ£"},
    "å¡™å®£ä¹‹": {"avg": 91.0, "std": 2.1, "desc": "ãƒœã‚±æ•°ãƒ»å”ä¼šç†äº‹å‹", "icon": "ğŸ‘“"},
    "ç¤¼äºŒ": {"avg": 92.0, "std": 2.5, "desc": "æ¼”æŠ€åŠ›ãƒ»ãƒ„ãƒƒã‚³ãƒŸé‡è¦–", "icon": "ğŸš„"},
    "ç«‹å·å¿—ã‚‰ã": {"avg": 89.5, "std": 4.5, "desc": "è«‡å¿—ã‚¤ã‚ºãƒ ãƒ»ä¸–ç•Œè¦³å‹", "icon": "ğŸ‘˜"},
    "å·¨äººå¸«åŒ ": {"avg": 91.5, "std": 2.0, "desc": "æ­£çµ±æ´¾ãƒ»æœ¬æ ¼ã—ã‚ƒã¹ãã‚Š", "icon": "ğŸ—¼"},
}

# ğŸ­ ã‚³ãƒ³ãƒ“æƒ…å ±
FINALISTS = {
    "ä»¤å’Œãƒ­ãƒãƒ³": {"tag": "æ²¡å…¥ãƒ»åˆ†æ", "copy": "é­”äººãŸã¡ã®æˆ¯ã‚Œ", "default": 94},
    "ãƒ¤ãƒ¼ãƒ¬ãƒ³ã‚º": {"tag": "é›‘è«‡ãƒ»æ‰‹æ•°", "copy": "å–‹ã‚Šã®ãŠã‚‚ã¡ã‚ƒç®±", "default": 93},
    "ã•ã‚„é¦™": {"tag": "ç†±è¡€ãƒ»å–§å˜©", "copy": "æ¿€æƒ…ã®æµªé€Ÿæ¼«æ‰", "default": 90},
    "ã‚«ãƒ™ãƒã‚¹ã‚¿ãƒ¼": {"tag": "æ§‹æˆãƒ»ä¼ç·š", "copy": "ãƒ­ã‚¸ã‚«ãƒ«ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼", "default": 92},
    "çœŸç©ºã‚¸ã‚§ã‚·ã‚«": {"tag": "å¤§å–œåˆ©ãƒ»çŸ¥æ€§", "copy": "æ­ªãªã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹", "default": 89},
    "ãƒ€ãƒ³ãƒ“ãƒ©ãƒ ãƒ¼ãƒãƒ§": {"tag": "æ­Œãƒã‚¿ãƒ»å¤©çœŸçˆ›æ¼«", "copy": "ç„¡é‚ªæ°—ãªéŸ³éŸ¿å…µå™¨", "default": 91},
    "ãƒãƒ¦ãƒªã‚«": {"tag": "å¹¼é¦´æŸ“ãƒ»æ‚²å“€", "copy": "ã‚ºãƒƒå‹ã‚¢ãƒ³ãƒãƒƒãƒ”ãƒ¼", "default": 88},
    "ã‚¦ã‚¨ã‚¹ãƒˆãƒ©ãƒ³ãƒ‰": {"tag": "æ¯’èˆŒãƒ»é­‚", "copy": "å°å¸‚æ°‘ã®æ€’ã‚Šçˆ†ç™º", "default": 92},
    "ãƒ¢ã‚°ãƒ©ã‚¤ãƒ€ãƒ¼": {"tag": "ã‚¢ãƒ‰ãƒªãƒ–ãƒ»å¤©ç„¶", "copy": "ãƒ‰ã‚¿ãƒã‚¿èª¿æ•™å¸«", "default": 87},
    "ãƒ­ãƒ³ã‚°ã‚³ãƒ¼ãƒˆãƒ€ãƒ‡ã‚£": {"tag": "è„±åŠ›ãƒ»ç™ºæƒ³", "copy": "ã‚†ã‚‹ãµã‚ã‚³ãƒ³ãƒˆå¸«", "default": 93},
}

# ==========================================
# 2. ã‚¢ãƒ—ãƒªç”»é¢è¨­å®š
# ==========================================
st.set_page_config(page_title="M-1å¯©æŸ»å“¡ã‚·ãƒ³ã‚¯ãƒ­ç‡è¨ºæ–­", layout="wide", page_icon="ğŸ†")

st.title("ğŸ† M-1å¯©æŸ»å“¡ã‚·ãƒ³ã‚¯ãƒ­è¨ºæ–­ Dashboard")
st.markdown("ã‚ãªãŸãŒã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã™ã¨ã€**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ **ã§è¨ºæ–­çµæœãŒå¤‰ã‚ã‚Šã¾ã™ã€‚")
st.divider()

# ç”»é¢ã‚’å·¦å³ã«åˆ†å‰²
col_input, col_result = st.columns([1.2, 1.5], gap="large")

# ==========================================
# 3. å·¦ã‚«ãƒ©ãƒ ï¼šæ¡ç‚¹å…¥åŠ›ã‚¨ãƒªã‚¢
# ==========================================
with col_input:
    st.subheader("ğŸ“ æ¡ç‚¹ã‚·ãƒ¼ãƒˆ")
    st.caption("ä»Šå¹´ã®ãƒ•ã‚¡ã‚¤ãƒŠãƒªã‚¹ãƒˆã«ç‚¹æ•°ã‚’ã¤ã‘ã¦ãã ã•ã„")
    
    user_scores = {}
    
    # ã‚³ãƒ³ãƒ“ã”ã¨ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’è¡¨ç¤º
    for name, info in FINALISTS.items():
        with st.container():
            c1, c2 = st.columns([3, 1])
            c1.markdown(f"**{name}** <small style='color:gray'>{info['tag']}</small>", unsafe_allow_html=True)
            c2.caption(f"Default: {info['default']}")
            
            score = st.slider(
                f"{info['copy']}",
                min_value=80, max_value=100, 
                value=info['default'],
                key=f"slider_{name}",
                label_visibility="collapsed"
            )
            user_scores[name] = score
            st.markdown("---")

# ==========================================
# 4. ãƒ­ã‚¸ãƒƒã‚¯è¨ˆç®—
# ==========================================
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµ±è¨ˆé‡
scores_list = list(user_scores.values())
user_avg = np.mean(scores_list)
user_std = np.std(scores_list)

# å¯©æŸ»å“¡ã¨ã®è·é›¢ã‚’è¨ˆç®—
ranking = []
for j_name, j_data in JUDGES_MASTER.items():
    # è·é›¢è¨ˆç®—ï¼ˆå¹³å‡ç‚¹ã®å·® + ãƒãƒ©ã¤ãã®å·®ï¼‰
    dist = (user_avg - j_data["avg"])**2 + (user_std - j_data["std"])**2 * 1.5
    ranking.append({"name": j_name, "dist": dist, "data": j_data})

# ã‚½ãƒ¼ãƒˆ
ranking.sort(key=lambda x: x["dist"])
best_match = ranking[0]
second_match = ranking[1]

# ==========================================
# 5. å³ã‚«ãƒ©ãƒ ï¼šåˆ†æçµæœ
# ==========================================
with col_result:
    # å°‘ã—ä½™ç™½ã‚’å…¥ã‚Œã‚‹
    st.write("") 
    
    st.subheader("ğŸ¤– ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æçµæœ")
    
    # çµæœè¡¨ç¤º
    result_container = st.container()
    result_container.success(f"ã‚ãªãŸã®ã‚¿ã‚¤ãƒ—ã¯... **ã€ {best_match['name']} ã€‘** ã§ã™ï¼")
    
    # æŒ‡æ¨™
    m1, m2, m3 = st.columns(3)
    m1.metric("å¹³å‡ç‚¹", f"{user_avg:.1f}ç‚¹", delta=f"{user_avg - 90:.1f} (åŸºæº–æ¯”)")
    m2.metric("ãƒãƒ©ã¤ã", f"{user_std:.1f}", help="æ•°å­—ãŒå¤§ãã„ã»ã©ã€å¥½ãå«Œã„ãŒæ¿€ã—ã„")
    m3.metric("ã‚·ãƒ³ã‚¯ãƒ­", best_match['data']['icon'] + best_match['name'])
    
    st.markdown(f"**ç‰¹å¾´:** {best_match['data']['desc']}")
    
    # --- ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ãƒãƒƒãƒ— ---
    st.write("### ğŸ“Š å¯©æŸ»å“¡ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ãƒãƒƒãƒ—")
    st.caption("ã‚ãªãŸ(ğŸ”´)ã¯ã€ä»–ã®å¯©æŸ»å“¡ã¨æ¯”ã¹ã¦ã©ã“ã«ã„ã‚‹ï¼Ÿ")
    
    # ãƒ—ãƒ­ãƒƒãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆ
    plot_data = []
    for name, d in JUDGES_MASTER.items():
        plot_data.append({"åå‰": name, "å¹³å‡ç‚¹": d["avg"], "ãƒãƒ©ã¤ã": d["std"], "ã‚¿ã‚¤ãƒ—": "å¯©æŸ»å“¡", "ã‚µã‚¤ã‚º": 80})
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
    plot_data.append({"åå‰": "ã‚ãªãŸ", "å¹³å‡ç‚¹": user_avg, "ãƒãƒ©ã¤ã": user_std, "ã‚¿ã‚¤ãƒ—": "ã‚ãªãŸ", "ã‚µã‚¤ã‚º": 200})
    
    df_plot = pd.DataFrame(plot_data)
    
    # æ•£å¸ƒå›³ã®æç”»ï¼ˆã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸï¼ï¼‰
    st.scatter_chart(
        df_plot,
        x='å¹³å‡ç‚¹',
        y='ãƒãƒ©ã¤ã',
        color='ã‚¿ã‚¤ãƒ—',
        size='ã‚µã‚¤ã‚º'
    )

    # ç¬¬2å€™è£œ
    with st.expander("ç¬¬2å€™è£œã®å¯©æŸ»å“¡ã‚’è¦‹ã‚‹"):
        st.write(f"æ¬¡ã¯ **{second_match['name']}** ({second_match['data']['desc']}) ã«è¿‘ã„ã§ã™ã€‚")
